<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>КТ №4. Геолокация и Хранилища</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 8px; }
        input { width: 300px; padding: 5px; }
        button { padding: 8px; margin-top: 10px; }
        #coords { margin: 15px 0; font-weight: bold; }
    </style>
</head>
<body>

<h1>Геолокация и Хранилища</h1>

<button id="getLocation">Определить местоположение</button>
<div id="coords">Координаты не определены</div>

<h2>LocalStorage</h2>
Комментарий: <input type="text" id="commentLS"><br>
<button id="saveLS">Сохранить в LocalStorage</button>

<h3>Записи из LocalStorage</h3>
<table id="lsTable">
    <thead>
        <tr><th>Время</th><th>Комментарий</th><th>Широта</th><th>Долгота</th></tr>
    </thead>
    <tbody></tbody>
</table>

<h2>IndexedDB</h2>
Комментарий: <input type="text" id="commentIDB"><br>
<button id="saveIDB">Сохранить в IndexedDB</button>

<h3>Записи из IndexedDB</h3>
<table id="idbTable">
    <thead>
        <tr><th>Время</th><th>Комментарий</th><th>Широта</th><th>Долгота</th></tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    let lat = null;
    let lng = null;
    let db = null;

    const coords = document.getElementById('coords');
    const lsBody = document.querySelector('#lsTable tbody');
    const idbBody = document.querySelector('#idbTable tbody');

    document.getElementById('getLocation').onclick = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                lat = pos.coords.latitude;
                lng = pos.coords.longitude;
                coords.innerHTML = 'Широта: ' + lat.toFixed(6) + ', Долгота: ' + lng.toFixed(6);
            }, () => alert('Не удалось получить геолокацию'));
        } else {
            alert('Браузер не поддерживает геолокацию');
        }
    };

    // LocalStorage
    function loadLS() {
        lsBody.innerHTML = '';
        let data = localStorage.getItem('geoLS');
        if (!data) data = '[]';
        data = JSON.parse(data);

        data.forEach(item => {
            let tr = document.createElement('tr');
            tr.innerHTML = '<td>' + new Date(item.time).toLocaleString() + '</td>' +
                           '<td>' + item.comment + '</td>' +
                           '<td>' + item.lat.toFixed(6) + '</td>' +
                           '<td>' + item.lng.toFixed(6) + '</td>';
            lsBody.appendChild(tr);
        });
    }

    document.getElementById('saveLS').onclick = function() {
        if (!lat || !lng) {
            alert('Сначала определите местоположение');
            return;
        }
        let comment = document.getElementById('commentLS').value;
        if (comment.trim() === '') {
            alert('Введите комментарий');
            return;
        }

        let data = localStorage.getItem('geoLS');
        if (!data) data = '[]';
        data = JSON.parse(data);
        data.push({
            comment: comment,
            lat: lat,
            lng: lng,
            time: Date.now()
        });
        localStorage.setItem('geoLS', JSON.stringify(data));
        document.getElementById('commentLS').value = '';
        loadLS();
    };

    // IndexedDB
    let request = indexedDB.open('GeoDB', 1);

    request.onupgradeneeded = function(e) {
        db = e.target.result;
        db.createObjectStore('comments', { autoIncrement: true });
    };

    request.onsuccess = function(e) {
        db = e.target.result;
        loadIDB();
    };

    function loadIDB() {
        if (!db) return;
        idbBody.innerHTML = '';
        let tx = db.transaction('comments', 'readonly');
        let store = tx.objectStore('comments');
        let req = store.getAll();

        req.onsuccess = function() {
            req.result.forEach(item => {
                let tr = document.createElement('tr');
                tr.innerHTML = '<td>' + new Date(item.time).toLocaleString() + '</td>' +
                               '<td>' + item.comment + '</td>' +
                               '<td>' + item.lat.toFixed(6) + '</td>' +
                               '<td>' + item.lng.toFixed(6) + '</td>';
                idbBody.appendChild(tr);
            });
        };
    }

    document.getElementById('saveIDB').onclick = function() {
        if (!lat || !lng) {
            alert('Сначала определите местоположение');
            return;
        }
        if (!db) {
            alert('База данных не готова');
            return;
        }
        let comment = document.getElementById('commentIDB').value;
        if (comment.trim() === '') {
            alert('Введите комментарий');
            return;
        }

        let tx = db.transaction('comments', 'readwrite');
        let store = tx.objectStore('comments');
        store.add({
            comment: comment,
            lat: lat,
            lng: lng,
            time: Date.now()
        });

        tx.oncomplete = function() {
            document.getElementById('commentIDB').value = '';
            loadIDB();
        };
    };

    loadLS();
</script>

</body>
</html>




